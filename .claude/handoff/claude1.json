{
  "from": "claude1",
  "location": "Mac (development)",
  "timestamp": "2025-12-07T17:35:00Z",
  "sequence": 41,
  "status": "REQUEST_UPDATE",
  "current_task": "Configure MusicBrainz replication + weekly Solr index refresh",
  "priority": "HIGH",
  "message": "Adding to previous request: Also set up weekly Solr index refresh. Search indexes are NOT included in replication - they need separate maintenance. Use systemd timer for weekly refresh (not cron).",
  "needs_response": true,
  "requested_tasks": [
    {
      "task": "Check current database freshness",
      "description": "Query the database to see when it was last updated.",
      "commands": [
        "podman exec musicbrainz-docker_db_1 psql -U musicbrainz musicbrainz_db -c \"SELECT * FROM replication_control;\""
      ]
    },
    {
      "task": "Enable hourly database replication",
      "description": "Configure replication in musicbrainz-docker per their docs",
      "documentation": "https://github.com/metabrainz/musicbrainz-docker"
    },
    {
      "task": "Create systemd service for DB replication",
      "file": "~/.config/systemd/user/musicbrainz-replication.service",
      "content": "[Unit]\nDescription=MusicBrainz Database Replication\nAfter=musicbrainz.service\nRequires=musicbrainz.service\n\n[Service]\nType=oneshot\nWorkingDirectory=%h/musicbrainz-docker\nExecStart=/usr/bin/podman-compose exec musicbrainz replication.sh\n\n[Install]\nWantedBy=default.target"
    },
    {
      "task": "Create systemd timer for hourly DB replication",
      "file": "~/.config/systemd/user/musicbrainz-replication.timer",
      "content": "[Unit]\nDescription=Run MusicBrainz replication hourly\n\n[Timer]\nOnCalendar=hourly\nPersistent=true\nRandomizedDelaySec=300\n\n[Install]\nWantedBy=timers.target"
    },
    {
      "task": "Create systemd service for Solr index refresh",
      "file": "~/.config/systemd/user/musicbrainz-solr-refresh.service",
      "content": "[Unit]\nDescription=MusicBrainz Solr Index Refresh\nAfter=musicbrainz.service\nRequires=musicbrainz.service\n\n[Service]\nType=oneshot\nWorkingDirectory=%h/musicbrainz-docker\n# Adjust command based on how musicbrainz-docker handles index updates\nExecStart=/usr/bin/podman-compose exec indexer /home/musicbrainz/musicbrainz-server/admin/BuildSitemaps.pl --ping\n# Or download fresh indexes from data.metabrainz.org\n\n[Install]\nWantedBy=default.target"
    },
    {
      "task": "Create systemd timer for weekly Solr refresh",
      "file": "~/.config/systemd/user/musicbrainz-solr-refresh.timer",
      "content": "[Unit]\nDescription=Refresh MusicBrainz Solr indexes weekly\n\n[Timer]\nOnCalendar=Sun 04:00:00\nPersistent=true\nRandomizedDelaySec=1800\n\n[Install]\nWantedBy=timers.target",
      "notes": "Runs Sunday 4 AM with up to 30 min random delay to avoid thundering herd"
    },
    {
      "task": "Enable and start all timers",
      "commands": [
        "systemctl --user daemon-reload",
        "systemctl --user enable musicbrainz-replication.timer musicbrainz-solr-refresh.timer",
        "systemctl --user start musicbrainz-replication.timer musicbrainz-solr-refresh.timer",
        "systemctl --user list-timers --all"
      ]
    },
    {
      "task": "Test replication manually first",
      "description": "Run one replication cycle manually to verify it works"
    },
    {
      "task": "Restore Solr recording index (immediate)",
      "description": "Download and restore the 46GB recording.tar.zst from data.metabrainz.org",
      "url": "https://data.metabrainz.org/pub/musicbrainz/data/solr-backups/20251206-041002/recording.tar.zst",
      "priority": "Do this first to fix broken search"
    }
  ],
  "best_practices_applied": {
    "db_replication": "Hourly - matches MusicBrainz packet release frequency, keeps data <1 hour stale",
    "solr_refresh": "Weekly - indexes don't change as frequently, reduces bandwidth",
    "randomized_delay": "Prevents all mirrors hitting servers at exact same time",
    "persistent": "Catches up on missed runs if server was down"
  },
  "context": {
    "musicbrainz_location": "~/musicbrainz-docker",
    "current_services": [
      "musicbrainz.service (enabled, running)",
      "interchord.service (enabled, running)"
    ],
    "linger_enabled": true
  },
  "notes": "User specifically requested systemd timers instead of cron. The Solr service file is a template - check musicbrainz-docker docs for exact index rebuild command. May need to download fresh backups from data.metabrainz.org instead of rebuilding locally."
}
